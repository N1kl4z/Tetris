<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>BDSM TETRIS: ULTIMATE</title>
  <style>
    :root{
      --bg:#05060f;
      --panel-bg: rgba(15, 20, 40, 0.95);
      --text:#e8eeff;
      --muted:#9fb0d8;
      --accent: #50e3ff;
      --border: rgba(255,255,255,.12);
      --glow: rgba(80, 227, 255, 0.4);
    }

    /* MR.BDSM MODE - KOPPARJ√ÑGAREN (tidigare Ronnie) */
    body.mrbdsm-mode {
      --accent: #d35400;
      --glow: rgba(211, 84, 0, 0.8);
      animation: copperPulse 2s infinite alternate;
    }
    @keyframes copperPulse {
      from { background: #2e1a05; }
      to { background: #1a0f02; }
    }
    body.mrbdsm-mode #board-container {
      box-shadow: 0 0 60px #d35400, inset 0 0 40px rgba(211, 84, 0, 0.3);
      border-color: #d35400 !important;
    }
    body.mrbdsm-mode .title::after {
      content: " ü•â";
      animation: spin 2s linear infinite;
    }

    /* TAN-TAN MODE - LEGENDEN (tidigare Mr.BDSM) */
    body.tantan-mode {
      --accent: #ffd700;
      --glow: rgba(255, 215, 0, 0.8);
      background: radial-gradient(circle at 50% 50%, #1a1510 0%, #000000 100%) !important;
    }
    body.tantan-mode #board-container {
      box-shadow: 0 0 100px #ffd700, inset 0 0 60px rgba(255, 215, 0, 0.2) !important;
      border: 4px solid #ffd700 !important;
      animation: goldGlow 1s infinite alternate !important;
    }
    @keyframes goldGlow {
      from { box-shadow: 0 0 100px #ffd700, inset 0 0 60px rgba(255, 215, 0, 0.2); }
      to { box-shadow: 0 0 150px #ffd700, inset 0 0 80px rgba(255, 215, 0, 0.4); }
    }
    body.tantan-mode .title::after {
      content: " üëë";
      display: inline-block;
      animation: spin 3s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* DURACELL MODE - ENERGIBOMBEN (tidigare Tan-Tan) */
    body.duracell-mode {
      --accent: #ff00ff;
      --glow: rgba(255, 0, 255, 0.8);
      animation: energyShake 0.1s infinite;
    }
    @keyframes energyShake {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(2px, 2px) rotate(1deg); }
      75% { transform: translate(-2px, -2px) rotate(-1deg); }
    }
    body.duracell-mode #board-container {
      box-shadow: 0 0 80px #ff00ff, 0 0 40px #ff00ff;
      border-color: #ff00ff !important;
      animation: borderPulse 0.5s infinite;
    }
    @keyframes borderPulse {
      0%, 100% { border-width: 3px; }
      50% { border-width: 6px; }
    }
    body.duracell-mode .title::after {
      content: " üîã";
      animation: bounce 0.3s infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    *{ box-sizing:border-box; -webkit-user-select: none; touch-action: none; -webkit-tap-highlight-color: transparent; }
    html,body{ height: 100%; width: 100%; overflow: hidden; position: fixed; margin:0; }
    
    body{
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 1s ease, transform 0.1s;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100dvh;
      background: radial-gradient(circle at 50% 20%, #1a1b3a 0%, #05060f 100%);
    }

    header {
      padding: calc(8px + env(safe-area-inset-top)) 15px 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .title { 
      font-weight: 900; 
      letter-spacing: 2px; 
      color: var(--accent); 
      text-shadow: 0 0 15px var(--glow); 
      font-size: clamp(18px, 5vw, 28px);
      display: inline-block;
    }
    .subtitle { 
      font-size: clamp(8px, 2vw, 11px); 
      color: var(--muted); 
      text-transform: uppercase; 
    }

    .game-area {
      flex: 1; 
      display: flex; 
      justify-content: center; 
      align-items: center;
      gap: clamp(10px, 2vw, 20px); 
      padding: 8px; 
      min-height: 0;
    }

    #board-container {
      position: relative; 
      border: 3px solid var(--border); 
      border-radius: 12px;
      background: #000; 
      box-shadow: 0 0 40px rgba(0,0,0,0.8);
      transition: all 0.3s;
    }
    
    canvas#game-canvas { 
      display: block; 
      height: 65dvh;
      width: auto; 
      aspect-ratio: 1/2;
      max-height: 800px;
    }

    .hud { 
      display: flex; 
      flex-direction: column; 
      gap: clamp(8px, 2vh, 12px); 
      min-width: clamp(90px, 15vw, 120px);
    }
    .hud-box {
      background: var(--panel-bg); 
      border: 1px solid var(--border);
      padding: clamp(8px, 2vw, 14px); 
      border-radius: 16px; 
      text-align: center;
      transition: all 0.3s;
    }
    .hud-box label { 
      display: block; 
      font-size: clamp(9px, 2vw, 11px); 
      color: var(--muted); 
      text-transform: uppercase; 
      font-weight: bold; 
      margin-bottom: 4px; 
    }
    .hud-box span { 
      font-weight: 900; 
      font-size: clamp(18px, 4vw, 26px); 
      color: var(--accent); 
    }
    #next-canvas { 
      width: 100%; 
      aspect-ratio: 1;
      max-width: 100px;
      margin: 5px auto; 
      display: block; 
    }

    /* CONTROLS - ST√ñRRE OCH SNYGGARE KNAPPAR */
    .controls { 
      padding: 18px 15px calc(25px + env(safe-area-inset-bottom)); 
      background: linear-gradient(180deg, rgba(5, 10, 25, 0.4) 0%, rgba(0,0,0,0.8) 100%); 
      backdrop-filter: blur(20px);
      border-top: 2px solid rgba(80, 227, 255, 0.15);
      box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
    }
    .controls-grid { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      max-width: 650px; 
      margin: 0 auto; 
      gap: 22px;
    }
    .move-group { 
      display: grid; 
      grid-template-columns: repeat(3, clamp(70px, 16vw, 90px));
      gap: clamp(12px, 3vw, 18px);
    }
    .action-group { 
      display: flex; 
      flex-direction: column; 
      gap: clamp(8px, 2vw, 14px); 
    }

    .btn {
      width: clamp(70px, 16vw, 90px);
      height: clamp(70px, 16vw, 90px);
      background: linear-gradient(135deg, rgba(80, 227, 255, 0.2) 0%, rgba(80, 227, 255, 0.05) 100%);
      border: 2px solid var(--accent);
      border-radius: 50%;
      color: var(--accent); 
      font-size: clamp(26px, 6vw, 36px);
      font-weight: 900;
      display: flex; 
      justify-content: center; 
      align-items: center;
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5), 0 0 20px var(--glow), inset 0 1px 0 rgba(255,255,255,0.1);
      position: relative;
      text-shadow: 0 0 10px var(--glow);
    }
    .btn::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      padding: 2px;
      background: linear-gradient(135deg, var(--accent), transparent);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .btn:active { 
      transform: scale(0.92); 
      background: linear-gradient(135deg, var(--accent) 0%, rgba(80, 227, 255, 0.9) 100%);
      color: #000; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.6), 0 0 35px var(--accent), inset 0 0 20px rgba(255,255,255,0.4);
      border-color: var(--accent);
      text-shadow: none;
    }
    .btn:active::before {
      opacity: 1;
    }
    
    .btn-long { 
      width: clamp(145px, 30vw, 170px);
      height: clamp(58px, 13vw, 72px);
      border-radius: 36px; 
      font-size: clamp(14px, 3.2vw, 18px); 
      font-weight: 900; 
      text-transform: uppercase;
      letter-spacing: 1.5px;
      background: linear-gradient(135deg, rgba(80, 227, 255, 0.2) 0%, rgba(80, 227, 255, 0.08) 100%);
      box-shadow: 0 6px 20px rgba(0,0,0,0.5), 0 0 25px var(--glow), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    .btn-long::before {
      border-radius: 36px;
    }
    .btn-long:active {
      box-shadow: 0 2px 10px rgba(0,0,0,0.6), 0 0 40px var(--accent), inset 0 3px 15px rgba(0,0,0,0.4);
    }
    
    .btn-special { 
      border-color: var(--accent);
      border-width: 3px;
      background: linear-gradient(135deg, var(--accent) 0%, rgba(80, 227, 255, 0.7) 100%);
      color: #000;
      box-shadow: 0 6px 25px rgba(0,0,0,0.6), 0 0 30px var(--accent), inset 0 1px 0 rgba(255,255,255,0.3);
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .btn-special::before {
      opacity: 0.5;
    }
    .btn-special:active {
      background: linear-gradient(135deg, rgba(80, 227, 255, 1) 0%, var(--accent) 100%);
      box-shadow: 0 2px 12px rgba(0,0,0,0.7), 0 0 45px var(--accent), inset 0 3px 20px rgba(0,0,0,0.3);
      transform: scale(0.95);
    }
    
    #ctrl-drop {
      background: linear-gradient(135deg, rgba(255, 80, 80, 0.3) 0%, rgba(255, 128, 128, 0.15) 100%);
      border-color: #ff6b6b;
      border-width: 3px;
      color: #ff6b6b;
      box-shadow: 0 6px 25px rgba(0,0,0,0.6), 0 0 30px rgba(255, 107, 107, 0.5);
      text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
    }
    
    #ctrl-drop:active {
      background: linear-gradient(135deg, #ff6b6b 0%, #ff4d4d 100%);
      color: #000;
      border-color: #ff6b6b;
      box-shadow: 0 2px 12px rgba(0,0,0,0.7), 0 0 45px #ff6b6b, inset 0 3px 20px rgba(0,0,0,0.3);
      text-shadow: none;
      transform: scale(0.95);
    }

    /* OVERLAYS */
    .overlay {
      position: fixed; 
      inset: 0; 
      background: rgba(2,3,10,0.98);
      backdrop-filter: blur(20px); 
      display: grid; 
      place-items: center; 
      z-index: 2000;
      overflow-y: auto;
    }
    .hidden { display: none !important; }
    .card {
      background: var(--panel-bg); 
      border: 1px solid var(--border);
      padding: clamp(25px, 5vw, 40px); 
      border-radius: 35px; 
      width: 90%; 
      max-width: 450px; 
      text-align: center;
      margin: 20px;
    }

    input[type="text"] {
      width: 100%; 
      padding: clamp(16px, 4vw, 24px); 
      border-radius: 20px; 
      border: 2px solid var(--border);
      background: rgba(0,0,0,0.6); 
      color: #fff; 
      text-align: center; 
      font-size: clamp(18px, 4.5vw, 24px);
      font-weight: 600;
      margin-bottom: 20px;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05);
      transition: all 0.3s ease;
    }
    input:focus { 
      border-color: var(--accent); 
      outline: none;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.5), 0 0 20px var(--glow);
      background: rgba(0,0,0,0.8);
    }

    /* TOGGLE SWITCHES */
    .settings-section {
      margin: 20px 0;
      padding: 25px;
      background: rgba(0,0,0,0.4);
      border-radius: 25px;
      text-align: left;
      border: 1px solid var(--border);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .settings-section h3 {
      color: var(--accent);
      font-size: clamp(18px, 4vw, 22px);
      margin-bottom: 20px;
      text-align: center;
      text-shadow: 0 0 10px var(--glow);
      font-weight: 900;
    }
    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .toggle-row:last-child { border-bottom: none; }
    .toggle-label {
      color: var(--text);
      font-size: clamp(14px, 3vw, 18px);
      font-weight: 600;
    }
    .toggle-switch {
      position: relative;
      width: 60px;
      height: 32px;
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid rgba(255,255,255,0.15);
      box-shadow: inset 0 2px 6px rgba(0,0,0,0.3);
    }
    .toggle-switch.active {
      background: linear-gradient(135deg, var(--accent) 0%, rgba(80, 227, 255, 0.7) 100%);
      border-color: var(--accent);
      box-shadow: 0 0 20px var(--glow), inset 0 2px 6px rgba(0,0,0,0.2);
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fff 0%, #e0e0e0 100%);
      top: 2px;
      left: 2px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .toggle-switch.active::after {
      left: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    .hs-table { 
      width: 100%; 
      margin: 20px 0; 
      border-collapse: collapse; 
      font-size: clamp(14px, 3vw, 17px); 
    }
    .hs-table tr { border-bottom: 1px solid rgba(255,255,255,0.05); }
    .hs-table td { padding: clamp(8px, 2vw, 12px) 5px; }
    .hs-name { text-align: left; font-weight: bold; color: var(--muted); }
    .hs-score { text-align: right; color: var(--accent); font-weight: 900; }

    #toast {
      position: fixed; 
      top: 35%; 
      left: 50%; 
      transform: translate(-50%, -50%);
      z-index: 3000; 
      pointer-events: none; 
      opacity: 0;
    }
    #toast.show { animation: toastPop 1.5s ease-out; }
    @keyframes toastPop {
      0% { opacity: 0; transform: translate(-50%, 50%) scale(0.5); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
      100% { opacity: 0; transform: translate(-50%, -150%) scale(1); }
    }

    .easter-egg-hint {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255,255,255,0.03);
      border-radius: 15px;
      font-size: clamp(10px, 2vw, 12px);
      color: var(--muted);
      line-height: 1.6;
    }
    .easter-egg-hint strong { color: var(--accent); }
  </style>
</head>
<body>

  <div class="app-container">
    <header>
      <div class="logo-area">
        <div class="title" id="main-title">BDSM TETRIS</div>
        <div class="subtitle" id="main-subtitle">Ultimate Edition</div>
      </div>
      <button class="btn" id="btn-menu" style="width: clamp(50px, 12vw, 60px); height: clamp(50px, 12vw, 60px); font-size: clamp(20px, 5vw, 26px);">‚ò∞</button>
    </header>

    <div class="game-area">
      <div id="board-container">
        <canvas id="game-canvas"></canvas>
      </div>
      
      <div class="hud">
        <div class="hud-box">
          <label>N√§sta</label>
          <canvas id="next-canvas"></canvas>
        </div>
        <div class="hud-box">
          <label>Po√§ng</label>
          <span id="score-val">0</span>
        </div>
        <div class="hud-box">
          <label>Niv√•</label>
          <span id="level-val">1</span>
        </div>
        <div class="hud-box" id="mode-indicator" style="display:none;">
          <label>Mode</label>
          <span id="mode-name" style="font-size: clamp(12px, 2.5vw, 16px);">NORMAL</span>
        </div>
      </div>
    </div>

    <footer class="controls">
      <div class="controls-grid">
        <div class="move-group">
          <div></div><button class="btn" id="ctrl-up">‚Üë</button><div></div>
          <button class="btn" id="ctrl-left">‚Üê</button>
          <button class="btn" id="ctrl-down">‚Üì</button>
          <button class="btn" id="ctrl-right">‚Üí</button>
        </div>
        <div class="action-group">
          <button class="btn btn-long btn-special" id="ctrl-rotate">ROTERA</button>
          <button class="btn btn-long" id="ctrl-drop">DROP</button>
        </div>
      </div>
    </footer>
  </div>

  <div id="overlay-start" class="overlay">
    <div class="card">
      <h1 style="font-size: clamp(26px, 6vw, 36px); color: var(--accent); margin-bottom: 5px;">BDSM-TETRIS</h1>
      <p style="color: var(--muted); font-size: clamp(10px, 2vw, 13px); margin-bottom: 20px;">TOPP 5 SPELARE</p>
      
      <table class="hs-table" id="hs-body"></table>

      <input type="text" id="player-name" placeholder="Skriv ditt namn..." maxlength="15">
      <button class="btn btn-long btn-special" id="start-game" style="width: 100%; height: clamp(60px, 14vw, 75px); font-size: clamp(17px, 4.5vw, 24px); letter-spacing: 2px;">STARTA JAKTEN</button>
      
      <div class="easter-egg-hint">
        <strong>ü•ö Easter Eggs:</strong><br>
        Prova att skriva <strong>mr.bdsm</strong>, <strong>tan-tan</strong> eller <strong>duracell</strong> som namn!
      </div>
    </div>
  </div>

  <div id="overlay-menu" class="overlay hidden">
    <div class="card">
      <h2 style="font-size: clamp(22px, 5vw, 30px);">PAUS</h2>
      
      <div class="settings-section">
        <h3>‚öôÔ∏è Inst√§llningar</h3>
        <div class="toggle-row">
          <span class="toggle-label">üîä Ljud & Musik</span>
          <div class="toggle-switch active" id="toggle-audio"></div>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">üëª Visa Shadow</span>
          <div class="toggle-switch active" id="toggle-shadow"></div>
        </div>
      </div>

      <button class="btn btn-long btn-special" id="btn-resume" style="width: 100%; margin-top: 20px; height: clamp(58px, 12vw, 68px); font-size: clamp(15px, 3.5vw, 19px);">FORTS√ÑTT</button>
      <button class="btn btn-long" id="btn-restart" style="width: 100%; margin-top: 12px; background: linear-gradient(135deg, rgba(255,80,80,0.2) 0%, rgba(255,80,80,0.1) 100%); height: clamp(58px, 12vw, 68px); font-size: clamp(15px, 3.5vw, 19px); border-color: rgba(255,80,80,0.5);">TILL MENYN</button>
    </div>
  </div>

  <div id="toast"><h1 id="toast-txt" style="color: white; font-weight: 900; text-shadow: 0 0 30px var(--accent); font-size: clamp(32px, 8vw, 50px);">GRANDSLAM!</h1></div>

  <script>
    // --- INST√ÑLLNINGAR ---
    let audioEnabled = localStorage.getItem('bdsm_audio') !== 'false';
    let shadowEnabled = localStorage.getItem('bdsm_shadow') !== 'false';

    // --- LJUD & MUSIK ---
    let audioCtx = null;
    let musicTimeout = null;
    const notes = { 'C': 261.63, 'D': 293.66, 'E': 329.63, 'F': 349.23, 'G': 392.00, 'A': 440.00, 'B': 493.88 };
    const melody = [['E',4], ['B',2], ['C',2], ['D',4], ['C',2], ['B',2], ['A',4], ['A',2], ['C',2], ['E',4], ['D',2], ['C',2], ['B',4]];
    let mIdx = 0;

    function initAudio() { 
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function stopMusic() {
      if (musicTimeout) clearTimeout(musicTimeout);
      mIdx = 0;
    }

    function playMusic() {
      if (paused || gameOver || !audioCtx || !audioEnabled) return;
      const n = melody[mIdx];
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = gameMode === 'mrbdsm' ? 'sawtooth' : gameMode === 'duracell' ? 'square' : 'triangle';
      let freq = notes[n[0]];
      if (gameMode === 'duracell') freq *= 1.5;
      if (gameMode === 'tantan') freq *= 0.75;
      o.frequency.setValueAtTime(freq, audioCtx.currentTime);
      g.gain.setValueAtTime(0.05, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
      o.connect(g).connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.2);
      mIdx = (mIdx + 1) % melody.length;
      let speed = gameMode === 'duracell' ? 80 : gameMode === 'mrbdsm' ? 100 : 120;
      musicTimeout = setTimeout(playMusic, n[1] * speed);
    }

    function playSfx(f, t="square", d=0.1) {
      if (!audioCtx || !audioEnabled) return;
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
      g.gain.setValueAtTime(gameMode === 'duracell' ? 0.08 : 0.05, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
      o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
    }

    // --- SPELMOTOR ---
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const nCanvas = document.getElementById('next-canvas');
    const nCtx = nCanvas.getContext('2d');
    const COLS = 10, ROWS = 20;
    
    let score = 0, gameOver = true, paused = false, gameMode = 'normal';
    let grid = Array.from({length: ROWS}, () => Array(COLS).fill(0));
    let lastTime = 0, dropCounter = 0, dropInterval = 800;

    const SHAPES = {
      I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]], 
      J:[[1,0,0],[1,1,1],[0,0,0]],
      L:[[0,0,1],[1,1,1],[0,0,0]], 
      O:[[1,1],[1,1]], 
      S:[[0,1,1],[1,1,0],[0,0,0]],
      Z:[[1,1,0],[0,1,1],[0,0,0]], 
      T:[[0,1,0],[1,1,1],[0,0,0]]
    };
    
    const COLORS = { 
      I:'#00f0f0', J:'#0000f0', L:'#f0a000', O:'#f0f000', S:'#00f000', Z:'#f00000', T:'#a000f0' 
    };
    const COPPER = { 
      I:'#b87333', J:'#cd7f32', L:'#8b4513', O:'#d2691e', S:'#a0522d', Z:'#5d4037', T:'#3e2723' 
    };
    const GOLD = { 
      I:'#ffd700', J:'#ffed4e', L:'#ffc700', O:'#ffb700', S:'#ffa700', Z:'#ff9700', T:'#ff8700' 
    };
    const ENERGY = { 
      I:'#ff00ff', J:'#ff1aff', L:'#ff33ff', O:'#ff4dff', S:'#ff66ff', Z:'#ff80ff', T:'#ff99ff' 
    };

    let player = { pos:{x:0, y:0}, matrix:null, type:'' };
    let nextType = 'IJLOSTZ'[Math.random() * 7 | 0];

    function getColorPalette() {
      switch(gameMode) {
        case 'mrbdsm': return COPPER;
        case 'tantan': return GOLD;
        case 'duracell': return ENERGY;
        default: return COLORS;
      }
    }

    function collide(g, p) {
      for (let y = 0; y < p.matrix.length; ++y) {
        for (let x = 0; x < p.matrix[y].length; ++x) {
          if (p.matrix[y][x] !== 0 && (g[y + p.pos.y] && g[y + p.pos.y][x + p.pos.x]) !== 0) return true;
        }
      }
      return false;
    }

    function resetPlayer() {
      player.type = nextType; player.matrix = SHAPES[player.type];
      player.pos.y = 0; player.pos.x = (COLS / 2 | 0) - (player.matrix[0].length / 2 | 0);
      nextType = 'IJLOSTZ'[Math.random() * 7 | 0];
      drawNext();
      if (collide(grid, player)) {
        gameOver = true;
        stopMusic();
        saveHS(document.getElementById('player-name').value, score);
        document.getElementById('overlay-start').classList.remove('hidden');
        renderHS();
      }
    }

    function drawNext() {
      const size = nCanvas.width;
      nCtx.fillStyle = '#000'; 
      nCtx.fillRect(0,0,size,size);
      const m = SHAPES[nextType]; 
      const s = size / 5;
      const ox = (size - m[0].length * s) / 2;
      const oy = (size - m.length * s) / 2;
      const palette = getColorPalette();
      m.forEach((row, y) => row.forEach((v, x) => {
        if (v) {
          nCtx.fillStyle = palette[nextType];
          nCtx.fillRect(ox + x*s, oy + y*s, s-2, s-2);
          if (gameMode === 'duracell' || gameMode === 'tantan') {
            nCtx.shadowBlur = 15;
            nCtx.shadowColor = palette[nextType];
            nCtx.fillRect(ox + x*s, oy + y*s, s-2, s-2);
            nCtx.shadowBlur = 0;
          }
        }
      }));
    }

    function arenaSweep() {
      let rowCount = 0;
      outer: for (let y = ROWS - 1; y > 0; --y) {
        for (let x = 0; x < COLS; ++x) { if (grid[y][x] === 0) continue outer; }
        grid.splice(y, 1); grid.unshift(new Array(COLS).fill(0));
        ++y; rowCount++;
      }
      if (rowCount > 0) {
        let points = [0, 100, 300, 500, 1200][rowCount];
        if (gameMode === 'duracell') points *= 1.5;
        if (gameMode === 'tantan') points *= 2;
        
        score += Math.floor(points);
        document.getElementById('score-val').innerText = score;
        
        if (rowCount === 4) {
          const messages = {
            'normal': 'GRANDSLAM!',
            'mrbdsm': 'ü•â KOPPARST√ñLD!',
            'tantan': 'üëë LEGENDARISKT!',
            'duracell': 'üîã ENERGIBOMB!'
          };
          document.getElementById('toast-txt').innerText = messages[gameMode];
          document.getElementById('toast').classList.add('show');
          setTimeout(() => document.getElementById('toast').classList.remove('show'), 1500);
          playSfx(880, "square", 0.4);
        } else { 
          playSfx(440 * (gameMode === 'duracell' ? 1.5 : 1)); 
        }
      }
    }

    function draw() {
      const B = canvas.width / COLS;
      ctx.fillStyle = '#000'; 
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Shadow (Ghost Piece) - TOGGLE
      if (shadowEnabled) {
        let shadow = { pos: {...player.pos}, matrix: player.matrix };
        while (!collide(grid, shadow)) shadow.pos.y++; 
        shadow.pos.y--;
        ctx.globalAlpha = 0.15;
        shadow.matrix.forEach((row, y) => row.forEach((v, x) => {
          if (v) { 
            ctx.fillStyle = '#fff'; 
            ctx.fillRect((shadow.pos.x + x)*B, (shadow.pos.y + y)*B, B-1, B-1); 
          }
        }));
        ctx.globalAlpha = 1.0;
      }

      const palette = getColorPalette();
      
      // Grid
      grid.forEach((row, y) => row.forEach((v, x) => {
        if (v) { 
          ctx.fillStyle = palette[v];
          ctx.fillRect(x*B, y*B, B-1, B-1);
          
          if (gameMode === 'duracell' || gameMode === 'tantan') {
            ctx.shadowBlur = 10;
            ctx.shadowColor = palette[v];
            ctx.fillRect(x*B, y*B, B-1, B-1);
            ctx.shadowBlur = 0;
          }
        }
      }));

      // Active piece
      player.matrix.forEach((row, y) => row.forEach((v, x) => {
        if (v) { 
          ctx.fillStyle = palette[player.type];
          ctx.fillRect((player.pos.x + x)*B, (player.pos.y + y)*B, B-1, B-1);
          
          if (gameMode === 'duracell' || gameMode === 'tantan') {
            ctx.shadowBlur = 15;
            ctx.shadowColor = palette[player.type];
            ctx.fillRect((player.pos.x + x)*B, (player.pos.y + y)*B, B-1, B-1);
            ctx.shadowBlur = 0;
          }
        }
      }));
    }

    function getDropSpeed() {
      switch(gameMode) {
        case 'mrbdsm': return 900; // L√•ngsammare f√∂r kopparj√§garen
        case 'duracell': return 300; // Hypersnabb energi
        case 'tantan': return 700; // Lugn majest√§tisk
        default: return 800;
      }
    }

    function update(time = 0) {
      if (gameOver || paused) return;
      const dt = time - lastTime; 
      lastTime = time;
      dropCounter += dt;
      
      if (dropCounter > getDropSpeed()) {
        player.pos.y++;
        if (collide(grid, player)) { 
          player.pos.y--; 
          merge(grid, player); 
          resetPlayer(); 
          arenaSweep(); 
        }
        dropCounter = 0;
      }
      draw(); 
      requestAnimationFrame(update);
    }

    function merge(g, p) { 
      p.matrix.forEach((row, y) => row.forEach((v, x) => { 
        if (v) g[y + p.pos.y][x + p.pos.x] = p.type; 
      })); 
    }
    
    function rotate(m) { 
      return m[0].map((_, i) => m.map(row => row[i]).reverse()); 
    }

    // --- HIGH SCORE LOGIK ---
    function saveHS(n, s) {
      if (!n || s <= 0) return;
      let hs = JSON.parse(localStorage.getItem('bdsm_score_v5') || '[]');
      hs.push({n, s, mode: gameMode}); 
      hs.sort((a,b) => b.s - a.s);
      localStorage.setItem('bdsm_score_v5', JSON.stringify(hs.slice(0, 5)));
    }
    
    function renderHS() {
      const hs = JSON.parse(localStorage.getItem('bdsm_score_v5') || '[]');
      const body = document.getElementById('hs-body');
      if (hs.length === 0) { 
        body.innerHTML = '<tr><td colspan="2" style="opacity:0.5">Inga rekord √§nnu</td></tr>'; 
        return; 
      }
      const modeEmojis = {
        'normal': '',
        'mrbdsm': 'ü•â',
        'tantan': 'üëë',
        'duracell': 'üîã'
      };
      body.innerHTML = hs.map(i => 
        `<tr><td class="hs-name">${modeEmojis[i.mode] || ''} ${i.n}</td><td class="hs-score">${i.s}</td></tr>`
      ).join('');
    }

    // --- INST√ÑLLNINGAR TOGGLES ---
    document.getElementById('toggle-audio').onclick = function() {
      audioEnabled = !audioEnabled;
      this.classList.toggle('active', audioEnabled);
      localStorage.setItem('bdsm_audio', audioEnabled);
      if (!audioEnabled) stopMusic();
      else if (!paused && !gameOver) playMusic();
    };

    document.getElementById('toggle-shadow').onclick = function() {
      shadowEnabled = !shadowEnabled;
      this.classList.toggle('active', shadowEnabled);
      localStorage.setItem('bdsm_shadow', shadowEnabled);
    };

    // S√§tt initial toggle state
    document.getElementById('toggle-audio').classList.toggle('active', audioEnabled);
    document.getElementById('toggle-shadow').classList.toggle('active', shadowEnabled);

    // --- INTERACTIONS ---
    document.getElementById('start-game').onclick = () => {
      const name = document.getElementById('player-name').value.trim();
      if (!name) { alert("Ange ett namn f√∂r att starta!"); return; }
      
      if (audioEnabled) initAudio();
      
      // Detektera special modes
      const nameLower = name.toLowerCase().replace(/\s+/g, '').replace(/\./g, '').replace(/-/g, '');
      
      if (nameLower === 'mrbdsm') {
        gameMode = 'mrbdsm';
        document.body.className = 'mrbdsm-mode';
        document.getElementById('main-title').innerText = "MR.BDSM KOPPARJAKT";
        document.getElementById('main-subtitle').innerText = "V√§rdefulla metaller!";
      } else if (nameLower === 'tantan') {
        gameMode = 'tantan';
        document.body.className = 'tantan-mode';
        document.getElementById('main-title').innerText = "TAN-TAN LEGENDEN";
        document.getElementById('main-subtitle').innerText = "Den od√∂dlige m√§staren";
      } else if (nameLower === 'duracell') {
        gameMode = 'duracell';
        document.body.className = 'duracell-mode';
        document.getElementById('main-title').innerText = "DURACELLS ENERGI";
        document.getElementById('main-subtitle').innerText = "Maximum overdrive!";
      } else {
        gameMode = 'normal';
        document.body.className = '';
        document.getElementById('main-title').innerText = "BDSM TETRIS";
        document.getElementById('main-subtitle').innerText = "Ultimate Edition";
      }
      
      // Visa mode indicator
      if (gameMode !== 'normal') {
        document.getElementById('mode-indicator').style.display = 'block';
        const modeNames = {
          'mrbdsm': 'ü•â KOPPAR',
          'tantan': 'üëë LEGEND',
          'duracell': 'üîã ENERGI'
        };
        document.getElementById('mode-name').innerText = modeNames[gameMode];
      } else {
        document.getElementById('mode-indicator').style.display = 'none';
      }
      
      document.getElementById('overlay-start').classList.add('hidden');
      grid.forEach(r => r.fill(0)); 
      score = 0; 
      gameOver = false; 
      paused = false;
      document.getElementById('score-val').innerText = "0";
      resetPlayer(); 
      stopMusic(); 
      if (audioEnabled) playMusic(); 
      update();
    };

    document.getElementById('btn-menu').onclick = () => { 
      paused = true; 
      stopMusic(); 
      document.getElementById('overlay-menu').classList.remove('hidden'); 
    };
    
    document.getElementById('btn-resume').onclick = () => { 
      paused = false; 
      document.getElementById('overlay-menu').classList.add('hidden'); 
      if (audioEnabled) playMusic(); 
      update(); 
    };
    
    document.getElementById('btn-restart').onclick = () => location.reload();

    document.getElementById('ctrl-left').onclick = () => { 
      player.pos.x--; 
      if(collide(grid, player)) player.pos.x++; 
      playSfx(200, "triangle", 0.05); 
    };
    
    document.getElementById('ctrl-right').onclick = () => { 
      player.pos.x++; 
      if(collide(grid, player)) player.pos.x--; 
      playSfx(200, "triangle", 0.05); 
    };
    
    document.getElementById('ctrl-down').onclick = () => { 
      player.pos.y++; 
      if(collide(grid, player)) player.pos.y--; 
    };
    
    document.getElementById('ctrl-up').onclick = () => {
      let m = rotate(player.matrix); 
      let old = player.matrix; 
      player.matrix = m;
      if(collide(grid, player)) player.matrix = old;
      else playSfx(600, "sine", 0.05);
    };
    
    document.getElementById('ctrl-rotate').onclick = () => document.getElementById('ctrl-up').click();
    
    document.getElementById('ctrl-drop').onclick = () => {
      while(!collide(grid, player)) player.pos.y++;
      player.pos.y--; 
      merge(grid, player); 
      resetPlayer(); 
      arenaSweep();
      playSfx(150, "square", 0.2);
    };

    // Keyboard support
    document.addEventListener('keydown', (e) => {
      if (gameOver || paused) return;
      switch(e.key) {
        case 'ArrowLeft': document.getElementById('ctrl-left').click(); break;
        case 'ArrowRight': document.getElementById('ctrl-right').click(); break;
        case 'ArrowDown': document.getElementById('ctrl-down').click(); break;
        case 'ArrowUp': case ' ': document.getElementById('ctrl-up').click(); break;
      }
    });

    // Resize canvas responsively
    function resizeCanvas() {
      const canvasElement = document.getElementById('game-canvas');
      const nextCanvasElement = document.getElementById('next-canvas');
      const displayHeight = canvasElement.offsetHeight;
      const displayWidth = displayHeight / 2;
      
      canvas.width = Math.floor(displayWidth);
      canvas.height = Math.floor(displayHeight);
      
      const nextSize = nextCanvasElement.offsetWidth;
      nCanvas.width = nextSize;
      nCanvas.height = nextSize;
      
      if (!gameOver) draw();
      drawNext();
    }

    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('load', () => {
      resizeCanvas();
      renderHS();
    });

    renderHS();
  </script>
</body>
</html>
