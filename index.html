<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>BDSM TETRIS: ULTIMATE</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    
    :root{
      --bg:#0a0a0a;
      --panel-bg: #1a1a2e;
      --text:#00ff41;
      --muted:#00cc33;
      --accent: #00ff41;
      --border: #00ff41;
      --glow: rgba(0, 255, 65, 0.6);
      --shadow: #003311;
    }

    /* MR.BDSM MODE - KOPPARJÄGAREN */
    body.mrbdsm-mode {
      --accent: #ff8c00;
      --text: #ff8c00;
      --muted: #cc7000;
      --border: #ff8c00;
      --glow: rgba(255, 140, 0, 0.6);
      --shadow: #663300;
    }
    body.mrbdsm-mode #board-container {
      box-shadow: 0 0 40px #ff8c00;
      border-color: #ff8c00 !important;
    }

    /* TAN-TAN MODE - LEGENDEN */
    body.tantan-mode {
      --accent: #ffd700;
      --text: #ffd700;
      --muted: #ccaa00;
      --border: #ffd700;
      --glow: rgba(255, 215, 0, 0.6);
      --shadow: #665500;
    }
    body.tantan-mode #board-container {
      box-shadow: 0 0 50px #ffd700, 0 0 100px #ffd700;
      border-color: #ffd700 !important;
      animation: goldPulse 1s infinite alternate;
    }
    @keyframes goldPulse {
      from { box-shadow: 0 0 50px #ffd700; }
      to { box-shadow: 0 0 100px #ffd700, 0 0 150px #ffd700; }
    }

    /* DURACELL MODE - ENERGIBOMBEN */
    body.duracell-mode {
      --accent: #ff00ff;
      --text: #ff00ff;
      --muted: #cc00cc;
      --border: #ff00ff;
      --glow: rgba(255, 0, 255, 0.6);
      --shadow: #660066;
      animation: energyShake 0.1s infinite;
    }
    @keyframes energyShake {
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(2px, 2px); }
      75% { transform: translate(-2px, -2px); }
    }
    body.duracell-mode #board-container {
      box-shadow: 0 0 60px #ff00ff;
      border-color: #ff00ff !important;
      animation: borderPulse 0.5s infinite;
    }
    @keyframes borderPulse {
      0%, 100% { border-width: 4px; }
      50% { border-width: 6px; }
    }

    *{ 
      box-sizing:border-box; 
      -webkit-user-select: none; 
      touch-action: none; 
      -webkit-tap-highlight-color: transparent;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    html,body{ height: 100%; width: 100%; overflow: hidden; position: fixed; margin:0; }
    
    body{
      font-family: 'Press Start 2P', monospace;
      background: var(--bg);
      color: var(--text);
      transition: none;
    }

    /* CRT EFFECT */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
      background-size: 100% 2px, 3px 100%;
      pointer-events: none;
      z-index: 9999;
      opacity: 0.3;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100dvh;
      background: #0a0a0a;
      position: relative;
    }

    header {
      padding: calc(10px + env(safe-area-inset-top)) 15px 10px;
      display: flex; justify-content: space-between; align-items: center;
      background: #000;
      border-bottom: 3px solid var(--accent);
      box-shadow: 0 0 20px var(--glow);
    }
    .title { 
      font-size: clamp(12px, 4vw, 20px);
      color: var(--accent);
      text-shadow: 3px 3px 0 var(--shadow);
      letter-spacing: 2px;
    }
    .subtitle { 
      font-size: clamp(6px, 1.5vw, 8px);
      color: var(--muted);
      text-transform: uppercase;
      margin-top: 5px;
    }

    .game-area {
      flex: 1; 
      display: flex; 
      justify-content: center; 
      align-items: center;
      gap: clamp(15px, 3vw, 25px); 
      padding: 15px; 
      min-height: 0;
    }

    #board-container {
      position: relative; 
      border: 4px solid var(--border); 
      border-radius: 0;
      background: #000; 
      box-shadow: 0 0 30px var(--glow), inset 0 0 20px rgba(0,0,0,0.8);
      transition: none;
    }
    
    canvas#game-canvas { 
      display: block; 
      height: 65dvh;
      width: auto; 
      aspect-ratio: 1/2;
      max-height: 800px;
      image-rendering: pixelated;
    }

    .hud { 
      display: flex; 
      flex-direction: column; 
      gap: clamp(10px, 2vh, 15px); 
      min-width: clamp(100px, 18vw, 140px);
    }
    .hud-box {
      background: #000;
      border: 3px solid var(--border);
      padding: clamp(10px, 2vw, 15px); 
      border-radius: 0;
      text-align: center;
      box-shadow: 0 0 15px var(--glow), inset 0 0 10px rgba(0,0,0,0.5);
    }
    .hud-box label { 
      display: block; 
      font-size: clamp(6px, 1.5vw, 8px);
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .hud-box span { 
      font-weight: 400;
      font-size: clamp(16px, 4vw, 24px);
      color: var(--accent);
      text-shadow: 2px 2px 0 var(--shadow);
    }
    #next-canvas { 
      width: 100%; 
      aspect-ratio: 1;
      max-width: 120px;
      margin: 5px auto; 
      display: block;
      background: #000;
      border: 2px solid var(--border);
      image-rendering: pixelated;
    }

    /* RETRO CONTROLS */
    .controls { 
      padding: 15px 15px calc(25px + env(safe-area-inset-bottom)); 
      background: #000;
      border-top: 3px solid var(--accent);
      box-shadow: 0 0 20px var(--glow);
    }
    .controls-grid { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      max-width: 650px; 
      margin: 0 auto; 
      gap: 20px;
    }
    .move-group { 
      display: grid; 
      grid-template-columns: repeat(3, clamp(70px, 16vw, 90px));
      gap: clamp(12px, 3vw, 18px);
    }
    .action-group { 
      display: flex; 
      flex-direction: column; 
      gap: clamp(12px, 3vw, 18px); 
    }

    .btn {
      width: clamp(70px, 16vw, 90px);
      height: clamp(70px, 16vw, 90px);
      background: var(--border);
      border: 4px solid #000;
      border-radius: 0;
      color: #000;
      font-size: clamp(20px, 5vw, 28px);
      font-weight: 400;
      display: flex; 
      justify-content: center; 
      align-items: center;
      transition: none;
      cursor: pointer;
      box-shadow: 4px 4px 0 var(--shadow), 0 0 20px var(--glow);
      position: relative;
    }
    
    .btn:active { 
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--shadow);
      background: var(--shadow);
      color: var(--accent);
    }
    
    .btn-long { 
      width: clamp(145px, 30vw, 170px);
      height: clamp(55px, 12vw, 70px);
      border-radius: 0;
      font-size: clamp(8px, 2vw, 11px);
      font-weight: 400;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 0 10px;
    }
    
    #ctrl-drop {
      background: #ff0000;
      box-shadow: 4px 4px 0 #660000, 0 0 20px rgba(255, 0, 0, 0.6);
    }
    
    #ctrl-drop:active {
      background: #660000;
      color: #ff0000;
      box-shadow: 2px 2px 0 #330000;
    }

    /* NES SPLASH SCREEN */
    .overlay {
      position: fixed; 
      inset: 0; 
      background: #000;
      display: grid; 
      place-items: center; 
      z-index: 2000;
      overflow-y: auto;
    }
    .hidden { display: none !important; }
    
    .splash-screen {
      width: 100%;
      max-width: 600px;
      padding: 20px;
      text-align: center;
    }

    .splash-title {
      font-size: clamp(28px, 8vw, 56px);
      color: var(--accent);
      text-shadow: 5px 5px 0 var(--shadow);
      margin-bottom: 10px;
      animation: titleBlink 1.5s infinite;
      letter-spacing: 3px;
    }
    
    @keyframes titleBlink {
      0%, 49% { opacity: 1; }
      50%, 99% { opacity: 0.7; }
    }

    .splash-subtitle {
      font-size: clamp(8px, 2vw, 12px);
      color: var(--muted);
      margin-bottom: 40px;
      letter-spacing: 2px;
    }

    .menu-container {
      background: #000;
      border: 4px solid var(--accent);
      padding: 30px 20px;
      margin: 20px auto;
      max-width: 450px;
      box-shadow: 0 0 30px var(--glow), inset 0 0 20px rgba(0,0,0,0.5);
    }

    .menu-section {
      margin-bottom: 30px;
    }

    .menu-section h3 {
      font-size: clamp(10px, 2.5vw, 14px);
      color: var(--accent);
      text-shadow: 2px 2px 0 var(--shadow);
      margin-bottom: 20px;
      letter-spacing: 2px;
    }

    .menu-item {
      padding: 15px;
      margin: 10px 0;
      background: var(--border);
      color: #000;
      border: 3px solid #000;
      font-size: clamp(9px, 2vw, 12px);
      cursor: pointer;
      box-shadow: 4px 4px 0 var(--shadow);
      transition: none;
      text-align: center;
      letter-spacing: 1px;
    }

    .menu-item:hover {
      background: var(--shadow);
      color: var(--accent);
    }

    .menu-item:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--shadow);
    }

    .name-input {
      width: 100%;
      padding: 15px;
      background: #000;
      border: 3px solid var(--border);
      color: var(--accent);
      font-family: 'Press Start 2P', monospace;
      font-size: clamp(10px, 2.5vw, 14px);
      text-align: center;
      margin-bottom: 15px;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 0 15px var(--glow);
      letter-spacing: 2px;
    }
    
    .name-input::placeholder {
      color: var(--muted);
      opacity: 0.5;
    }

    .name-input:focus {
      outline: none;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.9), 0 0 25px var(--glow);
    }

    /* HIGH SCORE TABLE */
    .hs-table { 
      width: 100%;
      margin: 20px 0;
      border-collapse: collapse;
      font-size: clamp(8px, 2vw, 11px);
    }
    .hs-table tr { 
      border-bottom: 2px solid var(--border);
    }
    .hs-table td { 
      padding: clamp(10px, 2vw, 15px) 5px;
    }
    .hs-name { 
      text-align: left;
      color: var(--text);
    }
    .hs-score { 
      text-align: right;
      color: var(--accent);
      text-shadow: 2px 2px 0 var(--shadow);
    }

    /* TOGGLE SWITCHES - RETRO STYLE */
    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 2px solid var(--border);
    }
    .toggle-row:last-child { border-bottom: none; }
    .toggle-label {
      color: var(--text);
      font-size: clamp(7px, 1.8vw, 10px);
      letter-spacing: 1px;
    }
    .toggle-switch {
      width: 60px;
      height: 28px;
      background: #000;
      border: 3px solid var(--border);
      position: relative;
      cursor: pointer;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
    }
    .toggle-switch.active {
      background: var(--border);
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: var(--border);
      border: 2px solid #000;
      top: 2px;
      left: 2px;
      transition: left 0.1s;
      box-shadow: 2px 2px 0 rgba(0,0,0,0.5);
    }
    .toggle-switch.active::after {
      left: 32px;
      background: #000;
      border-color: var(--border);
    }

    /* TOAST */
    #toast {
      position: fixed; 
      top: 35%; 
      left: 50%; 
      transform: translate(-50%, -50%);
      z-index: 3000; 
      pointer-events: none; 
      opacity: 0;
      background: #000;
      border: 4px solid var(--accent);
      padding: 20px 40px;
      box-shadow: 0 0 40px var(--glow);
    }
    #toast.show { 
      animation: toastPop 1.5s ease-out; 
    }
    @keyframes toastPop {
      0% { opacity: 0; transform: translate(-50%, 50%) scale(0.8); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -150%) scale(1); }
    }
    #toast-txt {
      color: var(--accent);
      font-size: clamp(16px, 5vw, 28px);
      text-shadow: 3px 3px 0 var(--shadow);
      margin: 0;
      letter-spacing: 2px;
    }

    .easter-egg-hint {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 255, 65, 0.05);
      border: 2px solid var(--border);
      font-size: clamp(6px, 1.5vw, 8px);
      color: var(--muted);
      line-height: 1.8;
      letter-spacing: 1px;
    }
    .easter-egg-hint strong { 
      color: var(--accent);
    }

    /* PAUSE MENU */
    .pause-card {
      background: #000;
      border: 4px solid var(--accent);
      padding: 30px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 0 40px var(--glow), inset 0 0 30px rgba(0,0,0,0.5);
    }

    .pause-card h2 {
      font-size: clamp(16px, 4vw, 24px);
      color: var(--accent);
      text-shadow: 3px 3px 0 var(--shadow);
      margin-bottom: 25px;
      letter-spacing: 2px;
    }

    .pause-card .menu-item {
      margin: 15px 0;
    }
  </style>
</head>
<body>

  <div class="app-container">
    <header>
      <div class="logo-area">
        <div class="title" id="main-title">BDSM TETRIS</div>
        <div class="subtitle" id="main-subtitle">ULTIMATE EDITION</div>
      </div>
      <button class="btn" id="btn-menu" style="width: clamp(45px, 10vw, 55px); height: clamp(45px, 10vw, 55px); font-size: clamp(14px, 3vw, 18px);">☰</button>
    </header>

    <div class="game-area">
      <div id="board-container">
        <canvas id="game-canvas"></canvas>
      </div>
      
      <div class="hud">
        <div class="hud-box">
          <label>NÄSTA</label>
          <canvas id="next-canvas"></canvas>
        </div>
        <div class="hud-box">
          <label>POÄNG</label>
          <span id="score-val">0</span>
        </div>
        <div class="hud-box">
          <label>NIVÅ</label>
          <span id="level-val">1</span>
        </div>
        <div class="hud-box" id="mode-indicator" style="display:none;">
          <label>LÄGE</label>
          <span id="mode-name" style="font-size: clamp(8px, 2vw, 12px);">NORMAL</span>
        </div>
      </div>
    </div>

    <footer class="controls">
      <div class="controls-grid">
        <div class="move-group">
          <div></div><button class="btn" id="ctrl-up">▲</button><div></div>
          <button class="btn" id="ctrl-left">◄</button>
          <button class="btn" id="ctrl-down">▼</button>
          <button class="btn" id="ctrl-right">►</button>
        </div>
        <div class="action-group">
          <button class="btn btn-long" id="ctrl-rotate">ROTERA</button>
          <button class="btn btn-long" id="ctrl-drop">SLÄPP</button>
        </div>
      </div>
    </footer>
  </div>

  <!-- ARCADE STYLE SPLASH SCREEN -->
  <div id="overlay-start" class="overlay">
    <div class="splash-screen">
      <div class="splash-title">BDSM<br>TETRIS</div>
      <div class="splash-subtitle">© 2026 RETRO EDITION</div>
      
      <div class="menu-container">
        <!-- Player Name Section -->
        <div class="menu-section">
          <h3>▼ SPELARE ▼</h3>
          <input type="text" class="name-input" id="player-name" placeholder="SKRIV NAMN..." maxlength="12">
        </div>

        <!-- Main Menu -->
        <div class="menu-section">
          <h3>▼ HUVUDMENY ▼</h3>
          <button class="menu-item" id="start-game">
            <span style="color: #000;">►</span> STARTA SPEL <span style="color: #000;">◄</span>
          </button>
        </div>

        <!-- High Scores -->
        <div class="menu-section">
          <h3>▼ TOPPLISTA ▼</h3>
          <table class="hs-table" id="hs-body"></table>
        </div>

        <!-- Easter Eggs -->
        <div class="easter-egg-hint">
          <strong>★ HEMLIGA KODER ★</strong><br>
          MR.BDSM / TAN-TAN / DURACELL
        </div>
      </div>
    </div>
  </div>

  <!-- PAUSE MENU -->
  <div id="overlay-menu" class="overlay hidden">
    <div class="pause-card">
      <h2>= PAUS =</h2>
      
      <div class="menu-section">
        <h3>▼ INSTÄLLNINGAR ▼</h3>
        <div class="toggle-row">
          <span class="toggle-label">LJUD/MUSIK</span>
          <div class="toggle-switch active" id="toggle-audio"></div>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">SKUGGA</span>
          <div class="toggle-switch active" id="toggle-shadow"></div>
        </div>
      </div>

      <button class="menu-item" id="btn-resume">► FORTSÄTT</button>
      <button class="menu-item" id="btn-restart">◄ HUVUDMENY</button>
    </div>
  </div>

  <div id="toast"><h1 id="toast-txt">TETRIS!</h1></div>

  <script>
    // --- INSTÄLLNINGAR ---
    let audioEnabled = localStorage.getItem('bdsm_audio') !== 'false';
    let shadowEnabled = localStorage.getItem('bdsm_shadow') !== 'false';

    // --- LJUD & MUSIK ---
    let audioCtx = null;
    let musicTimeout = null;
    const notes = { 'C': 261.63, 'D': 293.66, 'E': 329.63, 'F': 349.23, 'G': 392.00, 'A': 440.00, 'B': 493.88 };
    const melody = [['E',4], ['B',2], ['C',2], ['D',4], ['C',2], ['B',2], ['A',4], ['A',2], ['C',2], ['E',4], ['D',2], ['C',2], ['B',4]];
    let mIdx = 0;

    function initAudio() { 
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function stopMusic() {
      if (musicTimeout) clearTimeout(musicTimeout);
      mIdx = 0;
    }

    function playMusic() {
      if (paused || gameOver || !audioCtx || !audioEnabled) return;
      const n = melody[mIdx];
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'square'; // Retro square wave
      let freq = notes[n[0]];
      if (gameMode === 'duracell') freq *= 1.5;
      if (gameMode === 'tantan') freq *= 0.75;
      o.frequency.setValueAtTime(freq, audioCtx.currentTime);
      g.gain.setValueAtTime(0.05, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
      o.connect(g).connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.2);
      mIdx = (mIdx + 1) % melody.length;
      let speed = gameMode === 'duracell' ? 80 : gameMode === 'mrbdsm' ? 100 : 120;
      musicTimeout = setTimeout(playMusic, n[1] * speed);
    }

    function playSfx(f, d=0.1) {
      if (!audioCtx || !audioEnabled) return;
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.type = 'square';
      o.frequency.setValueAtTime(f, audioCtx.currentTime);
      g.gain.setValueAtTime(0.1, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d);
      o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
    }

    // --- SPELMOTOR ---
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const nCanvas = document.getElementById('next-canvas');
    const nCtx = nCanvas.getContext('2d');
    const COLS = 10, ROWS = 20;
    
    let score = 0, gameOver = true, paused = false, gameMode = 'normal';
    let grid = Array.from({length: ROWS}, () => Array(COLS).fill(0));
    let lastTime = 0, dropCounter = 0, dropInterval = 800;

    const SHAPES = {
      I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]], 
      J:[[1,0,0],[1,1,1],[0,0,0]],
      L:[[0,0,1],[1,1,1],[0,0,0]], 
      O:[[1,1],[1,1]], 
      S:[[0,1,1],[1,1,0],[0,0,0]],
      Z:[[1,1,0],[0,1,1],[0,0,0]], 
      T:[[0,1,0],[1,1,1],[0,0,0]]
    };
    
    const COLORS = { 
      I:'#00ffff', J:'#0000ff', L:'#ff8800', O:'#ffff00', S:'#00ff00', Z:'#ff0000', T:'#ff00ff' 
    };
    const COPPER = { 
      I:'#ff8c00', J:'#ff7700', L:'#ff6600', O:'#ff9900', S:'#ffaa00', Z:'#cc7700', T:'#bb6600' 
    };
    const GOLD = { 
      I:'#ffd700', J:'#ffed4e', L:'#ffc700', O:'#ffb700', S:'#ffa700', Z:'#ff9700', T:'#ff8700' 
    };
    const ENERGY = { 
      I:'#ff00ff', J:'#ff33ff', L:'#ff66ff', O:'#ff99ff', S:'#ffccff', Z:'#cc00cc', T:'#990099' 
    };

    let player = { pos:{x:0, y:0}, matrix:null, type:'' };
    let nextType = 'IJLOSTZ'[Math.random() * 7 | 0];

    function getColorPalette() {
      switch(gameMode) {
        case 'mrbdsm': return COPPER;
        case 'tantan': return GOLD;
        case 'duracell': return ENERGY;
        default: return COLORS;
      }
    }

    function collide(g, p) {
      for (let y = 0; y < p.matrix.length; ++y) {
        for (let x = 0; x < p.matrix[y].length; ++x) {
          if (p.matrix[y][x] !== 0 && (g[y + p.pos.y] && g[y + p.pos.y][x + p.pos.x]) !== 0) return true;
        }
      }
      return false;
    }

    function resetPlayer() {
      player.type = nextType; player.matrix = SHAPES[player.type];
      player.pos.y = 0; player.pos.x = (COLS / 2 | 0) - (player.matrix[0].length / 2 | 0);
      nextType = 'IJLOSTZ'[Math.random() * 7 | 0];
      drawNext();
      if (collide(grid, player)) {
        gameOver = true;
        stopMusic();
        saveHS(document.getElementById('player-name').value, score);
        document.getElementById('overlay-start').classList.remove('hidden');
        renderHS();
      }
    }

    function drawNext() {
      const size = nCanvas.width;
      nCtx.fillStyle = '#000'; 
      nCtx.fillRect(0,0,size,size);
      const m = SHAPES[nextType]; 
      const s = size / 5;
      const ox = (size - m[0].length * s) / 2;
      const oy = (size - m.length * s) / 2;
      const palette = getColorPalette();
      m.forEach((row, y) => row.forEach((v, x) => {
        if (v) {
          nCtx.fillStyle = palette[nextType];
          nCtx.fillRect(ox + x*s, oy + y*s, s-2, s-2);
        }
      }));
    }

    function arenaSweep() {
      let rowCount = 0;
      outer: for (let y = ROWS - 1; y > 0; --y) {
        for (let x = 0; x < COLS; ++x) { if (grid[y][x] === 0) continue outer; }
        grid.splice(y, 1); grid.unshift(new Array(COLS).fill(0));
        ++y; rowCount++;
      }
      if (rowCount > 0) {
        let points = [0, 100, 300, 500, 1200][rowCount];
        if (gameMode === 'duracell') points *= 1.5;
        if (gameMode === 'tantan') points *= 2;
        
        score += Math.floor(points);
        document.getElementById('score-val').innerText = score;
        
        if (rowCount === 4) {
          const messages = {
            'normal': 'TETRIS!',
            'mrbdsm': 'KOPPAR!',
            'tantan': 'LEGEND!',
            'duracell': 'ENERGI!'
          };
          document.getElementById('toast-txt').innerText = messages[gameMode];
          document.getElementById('toast').classList.add('show');
          setTimeout(() => document.getElementById('toast').classList.remove('show'), 1500);
          playSfx(880, 0.4);
        } else { 
          playSfx(440); 
        }
      }
    }

    function draw() {
      const B = canvas.width / COLS;
      ctx.fillStyle = '#000'; 
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // RETRO GRID LINES
      ctx.strokeStyle = 'rgba(0, 255, 65, 0.1)';
      ctx.lineWidth = 1;
      for (let x = 0; x <= COLS; x++) {
        ctx.beginPath();
        ctx.moveTo(x * B, 0);
        ctx.lineTo(x * B, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y <= ROWS; y++) {
        ctx.beginPath();
        ctx.moveTo(0, y * B);
        ctx.lineTo(canvas.width, y * B);
        ctx.stroke();
      }

      // Shadow (Ghost Piece) - TOGGLE
      if (shadowEnabled) {
        let shadow = { pos: {...player.pos}, matrix: player.matrix };
        while (!collide(grid, shadow)) shadow.pos.y++; 
        shadow.pos.y--;
        ctx.globalAlpha = 0.2;
        shadow.matrix.forEach((row, y) => row.forEach((v, x) => {
          if (v) { 
            ctx.fillStyle = '#fff'; 
            ctx.fillRect((shadow.pos.x + x)*B, (shadow.pos.y + y)*B, B-1, B-1); 
          }
        }));
        ctx.globalAlpha = 1.0;
      }

      const palette = getColorPalette();
      
      // Grid
      grid.forEach((row, y) => row.forEach((v, x) => {
        if (v) { 
          ctx.fillStyle = palette[v];
          ctx.fillRect(x*B, y*B, B-1, B-1);
        }
      }));

      // Active piece
      player.matrix.forEach((row, y) => row.forEach((v, x) => {
        if (v) { 
          ctx.fillStyle = palette[player.type];
          ctx.fillRect((player.pos.x + x)*B, (player.pos.y + y)*B, B-1, B-1);
        }
      }));
    }

    function getDropSpeed() {
      switch(gameMode) {
        case 'mrbdsm': return 900;
        case 'duracell': return 300;
        case 'tantan': return 700;
        default: return 800;
      }
    }

    function update(time = 0) {
      if (gameOver || paused) return;
      const dt = time - lastTime; 
      lastTime = time;
      dropCounter += dt;
      
      if (dropCounter > getDropSpeed()) {
        player.pos.y++;
        if (collide(grid, player)) { 
          player.pos.y--; 
          merge(grid, player); 
          resetPlayer(); 
          arenaSweep(); 
        }
        dropCounter = 0;
      }
      draw(); 
      requestAnimationFrame(update);
    }

    function merge(g, p) { 
      p.matrix.forEach((row, y) => row.forEach((v, x) => { 
        if (v) g[y + p.pos.y][x + p.pos.x] = p.type; 
      })); 
    }
    
    function rotate(m) { 
      return m[0].map((_, i) => m.map(row => row[i]).reverse()); 
    }

    // --- HIGH SCORE LOGIK ---
    function saveHS(n, s) {
      if (!n || s <= 0) return;
      let hs = JSON.parse(localStorage.getItem('bdsm_score_retro') || '[]');
      hs.push({n, s, mode: gameMode}); 
      hs.sort((a,b) => b.s - a.s);
      localStorage.setItem('bdsm_score_retro', JSON.stringify(hs.slice(0, 5)));
    }
    
    function renderHS() {
      const hs = JSON.parse(localStorage.getItem('bdsm_score_retro') || '[]');
      const body = document.getElementById('hs-body');
      if (hs.length === 0) { 
        body.innerHTML = '<tr><td colspan="2" style="text-align:center; opacity:0.5">INGA REKORD</td></tr>'; 
        return; 
      }
      const modeIcons = {
        'normal': '',
        'mrbdsm': '◆',
        'tantan': '★',
        'duracell': '◉'
      };
      body.innerHTML = hs.map(i => 
        `<tr><td class="hs-name">${modeIcons[i.mode] || ''} ${i.n}</td><td class="hs-score">${i.s}</td></tr>`
      ).join('');
    }

    // --- INSTÄLLNINGAR TOGGLES ---
    document.getElementById('toggle-audio').onclick = function() {
      audioEnabled = !audioEnabled;
      this.classList.toggle('active', audioEnabled);
      localStorage.setItem('bdsm_audio', audioEnabled);
      if (!audioEnabled) stopMusic();
      else if (!paused && !gameOver) playMusic();
    };

    document.getElementById('toggle-shadow').onclick = function() {
      shadowEnabled = !shadowEnabled;
      this.classList.toggle('active', shadowEnabled);
      localStorage.setItem('bdsm_shadow', shadowEnabled);
    };

    // Sätt initial toggle state
    document.getElementById('toggle-audio').classList.toggle('active', audioEnabled);
    document.getElementById('toggle-shadow').classList.toggle('active', shadowEnabled);

    // --- INTERACTIONS ---
    document.getElementById('start-game').onclick = () => {
      const name = document.getElementById('player-name').value.trim();
      if (!name) { alert("ANGE NAMN FÖR ATT STARTA!"); return; }
      
      if (audioEnabled) initAudio();
      
      // Detektera special modes - acceptera både med och utan bindestreck
      const nameLower = name.toLowerCase().replace(/\s+/g, '').replace(/\./g, '').replace(/-/g, '');
      
      if (nameLower === 'mrbdsm') {
        gameMode = 'mrbdsm';
        document.body.className = 'mrbdsm-mode';
        document.getElementById('main-title').innerText = "RONNIES RESA";
        document.getElementById('main-subtitle').innerText = "KOPPARJAKTEN";
      } else if (nameLower === 'tantan') {
        gameMode = 'tantan';
        document.body.className = 'tantan-mode';
        document.getElementById('main-title').innerText = "TAN-TANS VÄRLD";
        document.getElementById('main-subtitle').innerText = "LEGENDEN LEVER";
      } else if (nameLower === 'duracell') {
        gameMode = 'duracell';
        document.body.className = 'duracell-mode';
        document.getElementById('main-title').innerText = "DURACELLS LABB";
        document.getElementById('main-subtitle').innerText = "ENERGIBOMBEN";
      } else {
        gameMode = 'normal';
        document.body.className = '';
        document.getElementById('main-title').innerText = "BDSM TETRIS";
        document.getElementById('main-subtitle').innerText = "ULTIMATE EDITION";
      }
      
      // Visa mode indicator
      if (gameMode !== 'normal') {
        document.getElementById('mode-indicator').style.display = 'block';
        const modeNames = {
          'mrbdsm': 'KOPPAR',
          'tantan': 'LEGEND',
          'duracell': 'ENERGI'
        };
        document.getElementById('mode-name').innerText = modeNames[gameMode];
      } else {
        document.getElementById('mode-indicator').style.display = 'none';
      }
      
      document.getElementById('overlay-start').classList.add('hidden');
      grid.forEach(r => r.fill(0)); 
      score = 0; 
      gameOver = false; 
      paused = false;
      document.getElementById('score-val').innerText = "0";
      resetPlayer(); 
      stopMusic(); 
      if (audioEnabled) playMusic(); 
      update();
    };

    document.getElementById('btn-menu').onclick = () => { 
      paused = true; 
      stopMusic(); 
      document.getElementById('overlay-menu').classList.remove('hidden'); 
    };
    
    document.getElementById('btn-resume').onclick = () => { 
      paused = false; 
      document.getElementById('overlay-menu').classList.add('hidden'); 
      if (audioEnabled) playMusic(); 
      update(); 
    };
    
    document.getElementById('btn-restart').onclick = () => location.reload();

    document.getElementById('ctrl-left').onclick = () => { 
      player.pos.x--; 
      if(collide(grid, player)) player.pos.x++; 
      playSfx(200, 0.05); 
    };
    
    document.getElementById('ctrl-right').onclick = () => { 
      player.pos.x++; 
      if(collide(grid, player)) player.pos.x--; 
      playSfx(200, 0.05); 
    };
    
    document.getElementById('ctrl-down').onclick = () => { 
      player.pos.y++; 
      if(collide(grid, player)) player.pos.y--; 
    };
    
    document.getElementById('ctrl-up').onclick = () => {
      let m = rotate(player.matrix); 
      let old = player.matrix; 
      player.matrix = m;
      if(collide(grid, player)) player.matrix = old;
      else playSfx(600, 0.05);
    };
    
    document.getElementById('ctrl-rotate').onclick = () => document.getElementById('ctrl-up').click();
    
    document.getElementById('ctrl-drop').onclick = () => {
      while(!collide(grid, player)) player.pos.y++;
      player.pos.y--; 
      merge(grid, player); 
      resetPlayer(); 
      arenaSweep();
      playSfx(150, 0.2);
    };

    // Keyboard support
    document.addEventListener('keydown', (e) => {
      if (gameOver || paused) return;
      switch(e.key) {
        case 'ArrowLeft': document.getElementById('ctrl-left').click(); break;
        case 'ArrowRight': document.getElementById('ctrl-right').click(); break;
        case 'ArrowDown': document.getElementById('ctrl-down').click(); break;
        case 'ArrowUp': case ' ': document.getElementById('ctrl-up').click(); break;
      }
    });

    // Resize canvas responsively
    function resizeCanvas() {
      const canvasElement = document.getElementById('game-canvas');
      const nextCanvasElement = document.getElementById('next-canvas');
      const displayHeight = canvasElement.offsetHeight;
      const displayWidth = displayHeight / 2;
      
      canvas.width = Math.floor(displayWidth);
      canvas.height = Math.floor(displayHeight);
      
      const nextSize = nextCanvasElement.offsetWidth;
      nCanvas.width = nextSize;
      nCanvas.height = nextSize;
      
      if (!gameOver) draw();
      drawNext();
    }

    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('load', () => {
      resizeCanvas();
      renderHS();
    });

    renderHS();
  </script>
</body>
</html>
